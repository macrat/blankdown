<!DOCTYPE html>

<html>
	<head>
		<title>blankdown - yet yet yet another markdown editor</title>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/routeros.min.css">

		<script src="https://unpkg.com/vue/dist/vue.js"></script>
		<script src="https://unpkg.com/vuex/dist/vuex.min.js"></script>
		<script src="https://unpkg.com/marked/marked.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

		<style>
			body {
				margin: 0;
				height: 100vh;
			}
			.nav-content-area {
				height: 100vh;
				overflow: auto;
				display: flex;
				flex-direction: column;
			}
			nav {
				flex: 0 0 auto;
			}
		</style>

		<style>
			.nav-header {
				background-color: white;
				padding: .3em .5em .5em;
			}

			.nav-header-link {
				color: #333;
				text-decoration: none;
				margin: 0 .5em;
				user-select: none;
				font-size: 120%;
			}

			.nav-drawer {
				background-color: rgba(255, 255, 255, 0.5);
				border-right: 1px solid rgba(0, 0, 0, 0.05);
				padding: 0 .5em;
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				width: 15em;
				z-index: 2;
			}

			.nav-drawer hr {
				background-color: #ccc;
				border: none;
				height: 1px;
			}
			
			.nav-drawer-title {
				font-size: 150%;
				margin: .5em 0;
				border-bottom: 1px solid #ccc;
				user-select: none;
			}

			.nav-drawer-link {
				color: black;
				text-decoration: none;
				display: block;
				margin: .7em 0;
			}

			.nav-blind {
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				z-index: 1;
			}

			.nav-slide-enter-active, .nav-slide-leave-active {
				transition: left .3s, opacity .3s;
			}
			.nav-slide-enter, .nav-slide-leave-to {
				left: -15em;
				opacity: 0.5;
			}

			.nav-show-content {
				transition: filter .3s;
				filter: none;
			}
			.nav-hide-content {
				transition: filter .3s;
				filter: blur(5px) grayscale(50%);
			}
		</style>

		<style>
			.dialog-show-content {
				transition: filter .3s;
				filter: none;
			}
			.dialog-hide-content {
				transition: filter .3s;
				filter: blur(5px) grayscale(50%);
			}

			.dialog-backboard {
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.dialog-window {
				background-color: rgba(255, 255, 255, 0.5);;
				border: 1px solid rgba(0, 0, 0, 0.05);
				text-align: center;
				padding: 3em 5em;
			}

			.dialog-enter-active, .dialog-leave-active {
				transition: opacity .3s;
			}
			.dialog-enter, .dialog-leave-to {
				opacity: 0;
			}
		</style>
	</head>

	<body>
		<div id=app></div>
	</body>

	<script>
marked.setOptions({
	highlight(code, lang) {
		try {
			if (lang) {
				return hljs.highlight(lang, code, true).value;
			} else {
				return hljs.highlightAuto(code).value;
			}
		} catch(e) {
			return code;
		}
	},
});


const store = new Vuex.Store({
	state: {
		markdown: "# hello world\nwelcome to **blankdown**!\n\n```\nprint('this is ', end='')\n\nwhile True:\n    print('yet ', end='')\n\nprint('another markdown editor')\n```\n",
	},
	mutations: {
		update_markdown(state, markdown) {
			state.markdown = markdown;
		},
	},
	getters: {
		html(state) {
			return marked(state.markdown, {
				sanitize: true,
			});
		},
	},
});


Vue.directive('focus', {
	inserted(el) {
		el.focus();
	},
});


Vue.component('nav-wrapper', {
	computed: {
		groups() {
			return this.$slots.default.filter(slot => slot.componentOptions).map(slot => {
				return {
					slot: slot,
					name: slot.componentOptions.propsData.name,
				};
			});
		},
	},
	data() {
		return {
			opened: false,
		};
	},
	template: `
		<div class=nav-wrapper>
			<div class=nav-content-area :class="{ 'nav-show-content': !opened, 'nav-hide-content': opened }">
				<nav class=nav-header>
					<a href class=nav-header-link v-for="group in groups" @click.prevent="open(group.slot.componentInstance)">{{ group.name }}</a>
				</nav>
				<div class=nav-blind v-if=opened @click=closeAll></div>
				<slot name=content />
			</div>
			<div>
				<slot />
			</div>
		</div>
	`,
	mounted() {
		this.groups.forEach(x => x.slot.componentInstance.$on('opened', opened => {
			this.opened = opened;
			this.$emit('opened', opened);
		}));
	},
	methods: {
		closeAll() {
			this.groups.forEach(slot => {
				slot.slot.componentInstance.close();
			});
		},
		open(component) {
			this.closeAll();
			component.open();
		},
	},
});


Vue.component('nav-drawer', {
	props: ['name'],
	data() {
		return {
			opened: false,
		};
	},
	template: `
		<transition name=nav-slide>
			<div class=nav-drawer v-if=opened>
				<h1 class=nav-drawer-title @click=close>{{ name }}</h1>
				<slot />
			</div>
		</transition>
	`,
	methods: {
		open() {
			this.opened = true;
			this.$emit('opened', true);
		},
		close() {
			this.opened = false;
			this.$emit('opened', false);
		},
	},
});


Vue.component('nav-button', {
	template: '<a href @click.prevent=click class="nav-drawer-link"><slot /></a>',
	methods: {
		click() {
			this.$emit('click');
		},
	},
});


Vue.component('synchronize-scroll', {
	template: `<div><slot /></div>`,
	computed: {
		elements() {
			return this.$slots.default.filter(x => x.componentInstance).map(x => x.componentInstance.$el);
		},
	},
	mounted() {
		this.elements.forEach(elm => {
			elm.addEventListener('scroll', () => {
				Vue.nextTick(() => {
					const rate = Math.round(elm.scrollTop / (elm.scrollHeight - elm.clientHeight) * 1000) / 1000;
					this.elements.forEach(e => {
						if (e != elm) {
							e.scrollTo(0, (e.scrollHeight - e.clientHeight) * rate);
						}
					});
				});
			});
		});
	},
});


Vue.component('markdown-writer', {
	template: `
		<synchronize-scroll style="display: flex;">
			<markdown-editor style="flex: 1 1 0; outline: none; border: 0; resize: none;" v-focus />
			<markdown-viewer style="flex: 1 1 0; padding-left: 1em;" />
		</synchronize-scroll>
	`,
});


Vue.component('markdown-editor', {
	template: `
		<textarea
			style="box-sizing: border-box;"
			@keydown.tab.prevent=indent
			@input="update($event.target.value)"
			:value="$store.state.markdown"></textarea>
	`,
	methods: {
		indent() {
			const elm = this.$el;
			const start = elm.selectionStart;

			elm.value = elm.value.slice(0, start) + '    ' + elm.value.slice(elm.selectionEnd);
			elm.selectionStart = elm.selectionEnd = start + 4;

			this.update(elm.value);
		},
		update(markdown) {
			this.$store.commit('update_markdown', markdown);
		},
	},
});


Vue.component('markdown-viewer', {
	template: '<div v-html="$store.getters.html" style="box-sizing: border-box; overflow: auto;" />',
});


Vue.component('dialog-window', {
	props: ['opened'],
	model: {
		prop: 'opened',
		event: 'switch',
	},
	template: `
		<div class="dialog-wrapper">
			<div :class="{ 'dialog-show-content': !opened, 'dialog-hide-content': opened }">
				<slot />
			</div>

			<transition name=dialog>
				<div class=dialog-backboard v-if=opened @click="$emit('switch', !opened)">
					<div class=dialog-window @click.stop>
						<slot name=dialog />
					</div>
				</div>
			</transition>
		</div>
	`,
});


Vue.component('markdown-filemanager', {
	data() {
		return {
			opened: false,
			current: '',
		};
	},
	template: `
		<dialog-window v-model=opened>
			<slot />

			<component slot=dialog :is=current ref=dialog />
		</dialog-window>
	`,
	components: {
		save: {
			data() {
				return {
					linkStyle: {
						'display': 'block',
						'color': 'black',
						'text-decoration': 'none',
						'margin': '1em 0',
						'font-size': '150%',
					},
				};
			},
			template: `
				<div>
					<a :style=linkStyle href @click.prevent=saveToFile>save to file</a>
					<a :style=linkStyle href @click.prevent=exportToFile>export as HTML</a>

					<a class=filemanager-download-link style="display: none;"></a>
				</div>
			`,
			methods: {
				startDownload(filename, mimetype, data) {
					const elm = this.$el.querySelector('.filemanager-download-link')
					elm.href = URL.createObjectURL(new Blob([ data ], { type: mimetype }));
					elm.download = filename;
					this.$el.querySelector('.filemanager-download-link').click();
				},
				saveToFile() {
					this.startDownload('blankdown.md', 'text/markdown', this.$store.state.markdown);
					this.$emit('close');
				},
				exportToFile() {
					this.startDownload(
						'blankdown.html',
						'text/html',
						this.$store.getters.html,
					);
					this.$emit('close');
				},
			},
		},
		load: {
			data() {
				return {
					linkStyle: {
						'display': 'block',
						'color': 'black',
						'text-decoration': 'none',
						'margin': '1em 0',
						'font-size': '150%',
					},
				};
			},
			template: `
				<div>
					<a :style=linkStyle href @click.prevent=selectFile>load from file</a>

					<input class=filemanager-input-file @change="loadFile(this.event.target.files)" type=file accept="text/*" style="display: none;">
				</div>
			`,
			methods: {
				selectFile() {
					this.$el.querySelector('.filemanager-input-file').click();
				},
				loadFile(files) {
					if (!files) {
						this.$emit('close');
						return;
					}

					const reader = new FileReader();
					reader.addEventListener('load', () => {
						this.$store.commit('update_markdown', reader.result);
						this.$emit('close');
					});
					reader.readAsText(files[0]);
				},
			},
		},
	},
	created() {
		this.$on('load', this.load);
		this.$on('save', this.save);

		this.$watch('opened', () => {
			if (this.opened) {
				Vue.nextTick(() => {
					this.$refs.dialog.$on('close', () => {
						this.opened = false;
					});
				});
			}
		});
	},
	methods: {
		load() {
			this.current = 'load';
			this.opened = true;
		},
		save() {
			this.current = 'save';
			this.opened = true;
		},
		close() {
			this.opened = false;
		},
	},
});


const vm = new Vue({
	el: '#app',
	store: store,
	template: `
		<main>
			<markdown-filemanager ref=filemanager>
				<nav-wrapper>
					<nav-drawer name="FILE">
						<nav-button @click="$refs.filemanager.$emit('save')">save</nav-button>
						<nav-button @click="$refs.filemanager.$emit('load')">load</nav-button>
						<hr>
						<nav-button>recent file</nav-button>
						<nav-button>recent file</nav-button>
						<nav-button>recent file</nav-button>
						<nav-button>recent file</nav-button>
						<nav-button>recent file</nav-button>
					</nav-drawer>

					<nav-drawer name="EDIT">
						<nav-button>insert header</nav-button>
						<nav-button>insert table</nav-button>
					</nav-drawer>

					<nav-drawer name="HELP">
						<nav-button>about</nav-button>
					</nav-drawer>

					<markdown-writer slot=content style="flex: 1 1 0"></markdown-writer>
				</nav-wrapper>
			</markdown-filemanager>
		</main>
	`,
});
	</script>
</html>
